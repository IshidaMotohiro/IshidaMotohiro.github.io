---
title: EBPM報告
author: "石田基広"
date: "2019年03月27日"
output:
  revealjs::revealjs_presentation:
    theme: blood
    highlight: pygments
    center: true
    increment: true
    reveal_options:
      slideNumber: true
      previewLinks: true
    css: ../style.css
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE, warning = FALSE, message = FALSE, cache = FALSE)
library(vars)
# library(httr)
library(Nippon)#estat APIでデータの時間を探すべき
library(tidyverse)
library(scales)
library(lubridate)
## 自身のAPPIDを指定
estat <- "http://api.e-stat.go.jp/rest/2.1/app/json/getStatsData?appId=956188d1fe50f81a3f8363310d14ea853eb5827e&lang=J&statsDataId="
ids <- "956188d1fe50f81a3f8363310d14ea853eb5827e"
statID = ""
setwd("~/Dropbox/R/Lectures/2019")
#load("ddf.Rdata")
#load("all_values2.Rdata")
load("20190320.Rdata")
```


## 徳島からの転出超過{#out1}

過去50年

![](images/year1958-2017-2.png)

```{r}
## tokushima20190316.R
## 長期人口移動 第4表 第5表
## https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00200523&tstat=000000070001&cycle=0&tclass1=000001051218&survey=%E4%BD%8F%E6%B0%91%E5%9F%BA%E6%9C%AC%E5%8F%B0%E5%B8%B3&result_page=1&second2=1
# 
library(lubridate)
tokuA <- read_excel(path = "~/Dropbox/R/API/eStat/population/第5表.xls", sheet = 1,
                    range = "H45:BO45",col_names = paste0("Y",1:60),
                    col_types = "numeric") %>% gather

tokuA <- tokuA %>% mutate(YEAR = ymd(paste0(1958:2017, "-01-01")))

tokuM <- read_excel(path = "~/Dropbox/R/API/eStat/population/第5表.xls", sheet = 2,
                   range = "H45:BO45",col_names = paste0("Y",1:60),
                   col_types = "numeric") %>% gather

tokuF <- read_excel(path = "~/Dropbox/R/API/eStat/population/第5表.xls", sheet = 3,
                    range = "H45:BO45",col_names = paste0("Y",1:60),
                    col_types = "numeric") %>% gather

toku <- tibble(NUM = c(tokuM$value, FEMALE = tokuF$value),
               GEND = rep(c("M","F"),each =NROW(tokuF)),
               YEAR = rep(ymd(paste0(1958:2017, "-01-01")),2))


library(ggplot2)
library(scales)

toku %>% mutate(超過 = NUM, 性別 = fct_recode(GEND, 女= "F", 男 = "M"))  %>%
                      ggplot(aes(x = YEAR, y = 超過, col = 性別)) + geom_line() +
                      scale_x_date(labels = date_format("%Y"),date_breaks = "5 year") + 
  theme(axis.text.x = element_text(angle = 30)) +
  ggtitle("1958年から2017年までの転出超過（全年齢）")
```


## 徳島からの転出者数{#out2}

過去20年


![](images/kengai.png)

```{r}
## tokushima_pref.R
all_values2%>% filter( tab == "C", cat01 == "総")  %>% 
  mutate(year = ymd(year), # 性別 = fct_recode(as.factor(`@cat01`), 総数="0", 男 ="1", 女 = "2"),
         転出 = SUM) %>%  
  ggplot(aes(year, 転出)) + geom_line() + # facet_grid(性別 ~ . ) +
  scale_x_date(labels = date_format("%Y%b"),date_breaks = "1 year") + 
  theme(axis.text.x = element_text(angle = 30)) + 
  ggtitle("徳島転出実数")# + theme_gray(base_family = "HiraKakuPro-W3") 

```

## 年齢階層別転出割合{#out_Age1}


![](images/tokushima_out_age_ratio.png)


平成21年以前は年齢別データのAPIがない


```{r}
#https://www.e-stat.go.jp/stat-search/database?page=1&toukei=00200523&tstat=000000070001&result_page=1
# キーワード検索
library(httr)
if(NROW(h24_29) < 1) {
  url <-
  paste0(
  "http://api.e-stat.go.jp/rest/2.1/app/json/getStatsList?appId=",
  ids,
  "&searchWord=",
  URLencode(
  "年齢（５歳階級），男女別他都道府県からの転入者数，他都道府県への転出者数，転入超過数－全国，都道府県，３大都市圏（東京圏，名古屋圏，大阪圏）"
  )
  
  )
  xx <- GET(url)
  
  content(xx)$GET_STATS_LIST$DATALIST_INF$TABLE_INF[[1]] %>% names
  d_lists  <-
  map_df(content(xx)$GET_STATS_LIST$DATALIST_INF$TABLE_INF,
  ~ .[c("@id", "STATISTICS_NAME")])
  d_lists
  
  h24_29 <- d_lists %>% split(.$`@id`) %>% map_df( ~ {
  # print(paste(.$`@id`, .$STATISTICS_NAME))
  url <- paste0(estat, .$`@id`)
  xx <- GET(url)
  Sys.sleep(2)
  coln <-
  content(xx)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE[[1]] %>% names
  df <-
  map_df(content(xx)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE,
  ~ .[coln])
  df$year <- str_extract(.$STATISTICS_NAME, "平成\\d{2}年")
  df %>% mutate(
  gend = fct_recode(
  `@cat01`,
  総  = "0",
  男  = "1",
  女  = "2"
  ),
  ages = `@cat02`,
  move = fct_recode(
  `@cat03`,
  転入  = "001",
  転出 = "002",
  超過  = "003"
  ),
  area = `@area`,
  num = as.numeric(`$`)
  ) %>%
  select(year, move, gend, ages, area, num)
  })
}

h24_29 %>% filter(move == "転出", gend == "総",  area == "36000") %>% group_by(year) %>% mutate(割合 = num / sum(num) * 2) %>% filter(ages %in% c("204","205","206","207") )  %>%
  mutate(年齢 = fct_recode(ages,  １５_１９ =  "204", ２０_２５= "205", ２６_３０ =  "206", ３０_３５= "207")) %>%
  ggplot(aes(x = year, y = 割合, fill = 年齢)) + geom_bar(stat = "identity")+ ggtitle("転出にしめる割合（15歳以上35歳以下に限定）") 

h24_29_total <-  h24_29 %>% filter(move == "転出", gend == "総", ages == "000", area == "36000") 

h24_29 %>% filter(move == "転出", gend == "総", ages %in% c("000"), area == "36000")
h24_29_ages  <- h24_29 %>% filter(move == "転出", gend == "総",  area == "36000")

h24_29_total_jouve <- h24_29 %>% filter(move == "転出", gend == "総", ages %in% c("204", "205"), area == "36000") %>% group_by(year) %>%  summarise(人数 = sum(num))

h24_29_total_jouve$人数 / h24_29_total$num

h24_29_total_jouve %>% left_join(h24_29_total) %>% select(year, 人数, num) %>% mutate(year = ymd(paste0(wareki2AD(year), "-01-01")),  割合 = 人数/num) %>% ggplot(aes(x = year, y = 割合)) + geom_line()
```



## 年齢階層別転入者割合{#in_Age1}


```{r eval=TRUE}

h24_29 %>% filter(move == "転入", gend == "総",  area == "36000") %>% group_by(year) %>% mutate(割合 = num / sum(num) * 2) %>% filter(ages %in% c("204","205","206","207") )  %>%
  mutate(年齢 = fct_recode(ages,  １５_１９ =  "204", ２０_２５= "205", ２６_３０ =  "206", ３０_３５= "207")) %>%
  ggplot(aes(x = year, y = 割合, fill = 年齢)) + geom_bar(stat = "identity")+ ggtitle("転入にしめる割合（15歳以上35歳以下に限定）") 

```


## ここ10年{#years10}

```{r eval=TRUE}
## 人口総計データ eStat_how_to.Rmd
# tokushima <- all_data %>% filter(`@cat01` == "000", `@area` == "36000") %>% mutate(人数 = as.numeric(`$`) * 1000, 年齢コード  =  `@cat02`,  年 = year) %>% select(人数, 年齢コード , 年)  %>% left_join(ages_names) %>% select(人数, 内訳 = 年齢  , 年) 

tokushima <- all_data %>% filter(`@cat01` == "000", `@area` == "36000") %>% mutate(人数 = as.numeric(`$`) * 1000, 内訳  =  `@cat02`,  年 = year) %>%  mutate(`@cat03`= coalesce(`@cat03`, "002"))  %>% select(人数, 内訳  , 年, `@cat03`) %>% filter(`@cat03` == "002")

all_values %>% select(-`@unit`) %>% filter(`@tab` %in% c("02","002","03","003")) %>%  
  mutate(
    種類  = fct_collapse(
      `@tab`,      #内移動  = c("01", "001"),
      転入  = c("02", "002"),
      転出  = c("03", "003")),
    #超過  = c("04", "004")
    内訳 = fct_collapse(
      `@cat01`,
      総   = c("0", "001"),
      男  = c("1", "002"),
      女  = c("003", "2"),
      比  = c("004")
    ),
    人数  = as.numeric(`$`),
    年 = ymd(str_replace(`@time`, "000000$", "01-01"))
  ) %>% filter(種類 == "転出", 内訳 == "総") %>% mutate(内訳= fct_recode(内訳, 転出 = "総") ) %>% 
  select(人数,内訳,年) %>% 
  bind_rows(tokushima %>% filter (内訳 %in% c("01005", "01006", "01007", "01008", "01009", "01010")) %>% 
              mutate(内訳 = fct_recode(内訳, 転出 = "総", ２０= "01005", ２５= "01006", ３０= "01007", ３５= "01008", ４０= "01009", ４５= "01010"))) %>% 
  ggplot(aes(x = 年, y =  人数, col = 内訳)) + geom_line() + xlab("") +ylab("") +
  scale_y_continuous(limits = c(10000, 55000),
                     breaks = seq(10000, 55000, 2000)) +
  scale_x_date(labels = date_format("%Y"),date_breaks = "1 year") + 
    theme(axis.text.x = element_text(angle = 30))  +  ggtitle("転出数と、主な年齢層の人口概数") 

```


## 主な転出先{#main_move1}

平成29年

```{r}
# https://www.e-stat.go.jp/stat-search/database?page=1&toukei=00200523&tstat=000000070001&result_page=1

if(NROW(ddf) < 1) {
  search <-
    paste0(
    "http://api.e-stat.go.jp/rest/2.1/app/json/getStatsList?appId=",
    ids,
    "&searchWord=",
    URLencode("男女，移動前の住所地別転入者数及び男女，移動後の住所地別転出者数－都道府県）")# 各年の 007
    )##URLencode(""),"&searchKind=2",
    
  xx <- GET(search)
  str(xx)
  length(xx)
  d_lists  <-
  map_dfr(content(xx)$GET_STATS_LIST$DATALIST_INF$TABLE_INF,
  ~ .[c("@id", "STATISTICS_NAME")])
  d_lists
  
  d_ <- d_lists %>% split(.$`@id`) %>% map_dfr(., ~ {
  url_ <- paste0(estat, .["@id"])
  year_ <- str_extract(.$STATISTICS_NAME, "平成\\d{2}年")
  # Sys.sleep(2)
  print(year_)
  H_ <- GET(url_)
  
  Sys.sleep(2)
  
  coln <-
  content(H_)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE[[1]] %>% names()
  df_ <-
  map_df(content(H_)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE,
  ~ .[coln])
  df_ %>% add_column(Year = year_)
  })
  ddf  <-
  d_ %>% mutate(
  from = `@cat01`,
  gend = `@cat02`,
  in_out = `@cat03`,
  japanese61 = `@cat04`,
  area  = `@area`,
  人数  = as.numeric(`$`)
  )  %>% select(Year, from, gend, in_out, japanese61, area,  人数)
}

ddf <- ddf %>% left_join(area, by = c("area" = "@code")) %>% mutate(地域 = `@name`) %>% select(-`@level`)

ddf %>% filter(Year == "平成24年", from == "36000", area == "27000") 
```
```{r}

## 転出数 のチェック
remove_area <- ddf %>% tail(22) %>% select(area) %>% pull
ddf %>% filter(Year == "平成29年", gend == "0", from  == "36000", in_out == "002", !area %in% c("00999", remove_area))  %>%  summarise(SUM = sum(人数, na.rm = TRUE))
```
```{r eval=TRUE}
cities <-ddf %>% filter(Year == "平成29年", gend == "0", from == "36000", in_out == "001") %>% tail(22)
ddf %>% filter(Year == "平成29年", gend == "0", from == "36000", in_out == "002", !area %in% cities$area) %>% 
  dplyr::select(地域,人数) %>% arrange(desc(人数))%>% head(10) %>% knitr::kable()
```


## 5. 主な転入元{#main_in1}

平成29年

```{r eval=TRUE}
ddf %>% filter(Year == "平成29年", gend == "0", from == "36000", in_out == "001", !area %in% cities$area) %>% 
  dplyr::select(地域,人数) %>% arrange(desc(人数)) %>% head(10) %>% knitr::kable()
```

## 転出先上位{#out_top3}


```{r eval=TRUE}
# "13000"  "27000"
ddf %>% filter(gend == "0", from == "36000", area %in%  c("13000" ,"27000","37000"), in_out == "002") %>% dplyr::select(Year, area, 人数) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 地域 = fct_recode(area, 東京="13000" ,大阪="27000",香川県="37000"))  %>% ggplot(aes(x = Year, y = 人数, col = 地域)) + geom_line()+  ggtitle("転出先上位") 
```



```{r}
# "13000"  "27000"
ddf %>% filter(gend == "0", from == "36000", area %in%  c("13000" ,"27000","37000"), in_out == "002") %>% dplyr::select(Year, area, 人数) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 地域 = fct_recode(area, 東京="13000" ,大阪="27000",香川県="37000"))  %>% ggplot(aes(x = Year, y = 人数, col = 地域)) + geom_line()+  ggtitle("転入元上位") 
```


## 転入元上位{#in_top3}


```{r eval=TRUE}
# "13000"  "27000"
ddf %>% filter(gend == "1", from == "36000", area %in%  c("13000" ,"27000","37000"), in_out == "001") %>% select(Year, area, 人数) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 地域 = fct_recode(area, 東京="13000" ,大阪="27000",香川県="37000"))  %>% ggplot(aes(x = Year, y = 人数, col = 地域)) + geom_line()
```

## 香川との転出入数{#kagawa}

```{r eval=TRUE}
ddf %>% filter(gend == "1", from == "36000", area %in%  c("37000"), in_out %in% c("001", "002")) %>% dplyr::select(Year, 地域, 人数, in_out) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 転出入 = fct_recode(in_out, 転入 = "001", 転出= "002"))  %>% ggplot(aes(x = Year, y = 人数, col = 転出入 )) + geom_line()
```



```{r}
# tmp<-ddf %>% filter(Year == "平成29年", gend == "0", after == "36000", area == "00999", in_out == "002") %>% select(Year, area, 人数)
# 
# tmp<-ddf %>% filter(Year == "平成29年", gend == "0", after == "36000", area == "27000") %>% mutate(種別 = fct_recode(gend, 転入 = "0" , 転出 = "1" , 超過 = "2" )) %>% select(Year, 種別, 人数)
#  tmp<-ddf %>% filter(Year == "平成24年", gend == "000", in_out == "002", after == "36000", area == "27000") 
```




```{r}
## 最近の転出数再掲{#year2009_}
## load("all_values2.Rdata")
all_values2 %>% filter(tab == "C") %>% mutate(転出数 = SUM, 内訳 = cat01) %>%
  ggplot(aes(x = year, y = 転出数 , col = 内訳)) + geom_line()+
  scale_y_continuous(limits = c(4000, 16000), breaks=seq(4000,16000,500))+
  scale_x_date(labels = date_format("%Y"),date_breaks = "1 year")+ theme(axis.text = element_text(angle = 30))# + theme_gray(base_family = "HiraKakuPro-W3") 
```

## 共変量{#ovariance}

時系列に影響

1. 実質GDP成長率
2. 地域間所得格差
3. 新規有効求人倍率



## 徳島の求人倍率{#tokushima_shinki}



```{r eval=TRUE}
## R/API/eStat/population/tokushima20190316.R
## load("~/Dropbox/R/Lectures/2019/shinki_.Rdata")%>% mutate(year = year(year)) 
shinki_mean1 <- shinki_ %>% mutate(year = ymd(X__1), year =year(year)) %>% group_by(year) %>% summarise(徳島 = mean(`36徳島`), 香川 = mean(`37香川`)) 
library(scales)

all_values2 %>% filter(tab == "C", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean1) %>% 
  mutate(転出数 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>%
  ggplot() + geom_line(aes(x = year, y = 転出数  ))  + 
  scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
  geom_line(aes(x = year, y = rescale(徳島, to = range(転出数) ) ), col = "red") + 
  scale_y_continuous(name = "転出数", sec.axis =  sec_axis(~ rescale(., to = range(shinki_mean1$徳島)), name = "徳島新規有効求人倍率"))+
   theme(axis.text = element_text(angle = 30))# + theme_gray(base_family = "HiraKakuPro-W3") 
# file
```


## 大阪の求人倍率{#osaka_shinki}

```{r eval=TRUE}
## 
if(! exists("all_values2")) {
  load("~/Dropbox/R/Lectures/2019/all_values2.Rdata")
}
shinki_mean <- shinki_ %>% mutate(year = ymd(X__1), year = year(year)) %>% group_by(year) %>% summarise(大阪 = mean(`27大阪`), 近畿 = mean(`G 近畿`))
#scale_to_value1 <- function(values) rescale(values, to = range(x$転出数))
# scale_to_value2 <- function(values) rescale(values, to = range(x$大阪))
all_values2 %>% filter(tab == "C", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean) %>% 
  mutate(転出数 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>%
  ggplot() + geom_line(aes(x = year, y = 転出数 ))  + 
  scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
  geom_line(aes(x = year, y = rescale(大阪, to = range(転出数)) , col = "red"))  + 
  scale_y_continuous(name = "転出数", sec.axis =  sec_axis(~ rescale(., to = range(shinki_mean$ 大阪)), name = "大阪有効求人倍率")) +
   theme(axis.text = element_text(angle = 30))# + theme_gray(base_family = "HiraKakuPro-W3") 
```


## 徳島からの転出再掲{#out2_again}

```{r eval=TRUE}
## tokushima_pref.R
all_values2%>% filter( tab == "C", cat01 == "総")  %>% 
  mutate(year = ymd(year), # 性別 = fct_recode(as.factor(`@cat01`), 総数="0", 男 ="1", 女 = "2"),
         転出 = SUM) %>%  
  ggplot(aes(year, 転出)) + geom_line() + # facet_grid(性別 ~ . ) +
  scale_x_date(labels = date_format("%Y%b"),date_breaks = "1 year") + 
  theme(axis.text.x = element_text(angle = 30)) + 
  ggtitle("徳島転出者実数")# + theme_gray(base_family = "HiraKakuPro-W3") 
```

```{r}
## 過去の転出超過{#past_again}
tokuA %>% mutate(超過 = value, 年 = YEAR)  %>%
                      ggplot(aes(x = 年, y = 超過)) + geom_line() +
                      scale_x_date(labels = date_format("%Y"),date_breaks = "5 year") +
   scale_y_continuous(breaks = seq(-19000,1000, by = 1000)) + 
  theme(axis.text.x = element_text(angle = 30)) +
  ggtitle("1958年から2017年までの転出超過（全年齢）")
```


## 当てはめと予測ヘ{#fitting_and_predict}

転出数を大阪の新規有効求人倍率で回帰

1. 原系列は非定常(KPSS検定)
2. 共和分の確認(Engle-Granger検定)
3. 二変量時系列解析（VARモデル）
3. 因果関係のGranger検定（予測精度への影響）

```{r eval = TRUE}
## 2018年はデータを除いて分析
all_values5 <- all_values2 %>% filter(tab == "C", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean) %>% 
  mutate(転出数 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>% 
  filter(year %within% interval(ymd ("1999-01-01"), ymd("2017-01-01"))) %>% arrange(year)
dat5 <- all_values5 %>% dplyr::select(転出数,大阪)# data.frame(Y =y, X = x1)
#dat <- dat %>% mutate(転出数 = log(転出数),大阪 = log(大阪+1))
dat5 <- ts(dat5, start = 1999, end = 2017, frequency = 1)
jigen <- VARselect(dat5)
model_vars5 <- VAR(y = dat5, type = "const", p = jigen$selection[1])
# summary(model_vars5)
# plot(model_vars5, names = "転出数")
#causality(model_vars, cause = "大阪") 
# causality(model_vars, cause = "転出数")
```

```{r}
##以下、転出超過で分析する場合
all_values4 <- tokuA %>% mutate(year = year(YEAR), 転出超過 = value) %>%  left_join(shinki_mean1) %>% 
  mutate(year = ymd(paste0(year,"-01-01"))) %>% filter(year %within% interval(ymd("1975-01-01"), ymd("2016-01-01"))) %>% dplyr::select(year, 転出超過,  徳島)
dat4 <- all_values4 %>% dplyr::select(転出超過,徳島)# data.frame(Y =y, X = x1)
#dat <- dat %>% mutate(転出数 = log(転出数),大阪 = log(大阪+1))
dat4 <- ts(dat4, start = 1999, end = 2018, frequency = 1)
jigen4 <- VARselect(dat4)
model_vars4 <- VAR(y = dat4, type = "const", p = jigen4$selection[1])
## summary(model_vars)
plot(model_vars4)
#causality(model_vars, cause = "大阪") 
#causality(model_vars4, cause = "転出超過")

```

```{r}
##以下は全データ
all_values3 <- all_values2 %>% filter(tab == "C", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean) %>% 
  mutate(転出数 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) 
dat <- all_values3 %>% dplyr::select(転出数,大阪)# data.frame(Y =y, X = x1)
#dat <- dat %>% mutate(転出数 = log(転出数),大阪 = log(大阪+1))
dat <- ts(dat, start = 1999, end = 2018, frequency = 1)
jigen <- VARselect(dat)
model_vars <- VAR(y = dat, type = "const", p = jigen$selection[1])
## summary(model_vars)
plot(model_vars)
#causality(model_vars, cause = "大阪") 
#
causality(model_vars, cause = "転出数")
```

## 当てはめ結果{#fitting}

![](images/vars5.png)

## 転出数の予測値{#predict}

2018年を取り除いての分析

2018年以降を予測

```{r eval=TRUE}
predict(model_vars5, n.ahead = 5)[[1]]$転出 %>% broom::tidy() %>% 
  add_column(年 = c("2018","2019","2020","2021","2022"), .before = "fcst") %>% 
  knitr::kable()
```

```{r}
## 2018年を取り分けていない
predict(model_vars, n.ahead = 5)[[1]]$転出 %>% broom::tidy() %>% add_column(年 = c("2018","2019","2020","2021","2022"),  .before = "fcst") %>% knitr::kable()
```

ちなみに2018年の日本人転出者数は11119 

## 転出数の予測範囲{#predict_range}

![](images/autoplot5.png)

```{r}
library(ggfortify)
autoplot(predict(model_vars5, n.ahead = 5), ts.colour = 1, predict.color = 1,predict.linetype = "dashed")
```

```{r}
# トレンド付きモデル
jigen_t <- VARselect(dat5, type = "both")
model_vars_t <- VAR(y = dat5, type = "both", p = jigen_t$selection[1])
summary(model_vars_t)
plot(model_vars_t, names = "転出数")
#causality(model_vars, cause = "大阪") 
causality(model_vars_t, cause = "転出数")
predict(model_vars_t, n.ahead = 5)[[1]]$転出 %>% broom::tidy() %>% 
  add_column(年 = c("2018","2019","2020","2021","2022"), .before = "fcst") %>% 
  knitr::kable()
```

```{r}
## インパルス
model_irf <- irf(model_vars5, n.ahead = 10)
plot(model_irf)
```

## 課題
10月に消費税増税


1. 増税などのイベントの取り込み
2. 共変量の追加
3. 状態空間モデルでの推定

```{r}
## 男女込みの転出超過
if(!exists("shinki_all")) {
  shinki_all <-
  read_excel(
  path = "~/Dropbox/R/API/eStat/population/nineth_table.xls",
  sheet = 1,
  range = "A3:BG676",
  #col_names = "Osaka",
  col_types = c("date", rep("numeric", 58))
  )
}
shinki_all_2 <- shinki_all %>% mutate(YEAR = ymd(X__1)) %>% dplyr::select(YEAR, 徳島 = `36徳島`) %>% filter(YEAR %within% interval(ymd("1958-01-01"), ymd("2017-12-01"))) %>% mutate(YEAR = year(YEAR)) %>%  group_by(YEAR) %>% summarise(徳島 = mean(徳島))
```

```{r}
############
dat <- tokuA  %>% dplyr::select(転出 = value, YEAR,  -key) %>% filter(YEAR %within% interval(ymd("1963-01-01"), ymd("2017-12-01"))) %>% mutate(YEAR = year(YEAR)) %>%   left_join(shinki_all_2)

library(urca)# 帰無仮説単位根なし
summary(ur.kpss(dat$転出)) 
summary(ur.kpss(dat$徳島))
library(forecast)
# 差分はどれくらい必要か
ndiffs(dat$転出 )
ndiffs(dat$徳島)
ggtsdisplay(dat$転出)
ggtsdisplay(dat$徳島)

## 共和分検定　
mat <- matrix(nrow = length(dat$転出), ncol = 2)
mat[,1] <- dat$転出
mat[,2] <- dat$徳島

## 帰無仮説は共和分が無い
summary(ca.po(mat, demean = "none"))
library(vars)

dat <- all_values3 %>% dplyr::select(転出数,大阪)# data.frame(Y =y, X = x1)
dat <- dat %>% mutate(転出数 = log(転出数),大阪 = log(大阪+1))
dat <- ts(dat, start = 1999, end = 2018, frequency = 1)
jigen <- VARselect(dat)
model_vars <- VAR(y = dat, type = "const", p = jigen$selection[1])
# summary(model_vars)
# causality(model_vars, cause = "徳島") 
# causality(model_vars, cause = "転出")
```




```{r}
###################################################################
###################################################################
all_values3 <- all_values2 %>% filter(tab == "C", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean) %>% 
  mutate(転出数 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) 

y <- ts(log(rev(all_values3$転出数)), start = 1999, end = 2018, frequency = 1)
x1 <-  ts(log(rev(all_values3$大阪)), start = 1999, end = 2018, frequency = 1)

library(urca)# 帰無仮説単位根なし
summary(ur.kpss(x1)) #いずれも0.05 棄却点を超えている
summary(ur.kpss(y))  # 

library(forecast)
# 差分はどれくらい必要か
ndiffs(x1)
ndiffs(y)
ggtsdisplay(x1)
ggtsdisplay(y)


## 最適なArimaモデル
model_arimax <- Arima(
  y = y,
  order = c(2,1,0),
  seasonal = list(order = c(0,0,0)),
  xreg = x1
)

model_arimax

checkresiduals(model_arimax)
library(tseries)
jarque.bera.test(resid(model_arimax))
# 
# 
# model_arimax2 <- auto.arima(
#   y = y, 
#   xreg = x1,
#   ic = "aic",
#   maxorder = 5,
#   stepwise = FALSE,
#   approximation = FALSE
# 
# )

naive_f_mean <- rwf(y, h= 20)
naive_f_mean
accuracy(naive_f_mean)
y2 <- ts(y, start = 2019, end = 2038, frequency = 1)
accuracy(naive_f_mean, x = y2)
```
```{r}
## 共和分検定　
mat <- matrix(nrow = length(y), ncol = 2)
mat[,1] <- y
mat[,2] <- x1
## 帰無仮説は共和分が無い
summary(ca.po(mat, demean = "none"))
## 棄却できない

library(vars)

dat <- all_values3 %>% dplyr::select(転出数,大阪)# data.frame(Y =y, X = x1)
dat <- dat %>% mutate(転出数 = log(転出数),大阪 = log(大阪+1))
dat <- ts(dat, start = 1999, end = 2018, frequency = 1)
jigen <- VARselect(dat)
model_vars <- VAR(y = dat, type = "const", p = jigen$selection[1])
# summary(model_vars)
# plot(model_vars)
# causality(model_vars, cause = "大阪")
# library(fpp)
# data("usconsumption")
# usconsumption %>% class
```


```{r}
target <- all_values2 %>% filter(tab == "C", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean) %>% 
  mutate(転出数 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>% select(year, SUM, 大阪)
## 萩原 164ページ
# 翼 258ページ
library(KFAS)
build_trend <- SSModel(
  H = NA,
  target ~ SSMtrend(degree = 2, Q = c(list(NA), list(NA))) + target$大阪
)

fit_trend <- fitSSM(build_trend, inits = c(1,1,1))

result <- KFS(
  fit_trend$model,
  filtering = c("state", "mean"),
  smoothing = c("state", "mean")
)

```


```{r}

ローカル線形トレンドモデル

転出人口のグラフに １５−２０，２０−２５−２５−３０歳の人口ラインを引く

転入人口の出身地域別グラフ

library(tseries)
PP.test(toku$NUM[toku$GEND == "M"])
PP.test(diff(toku$NUM))

toku_f <- toku %>% filter(GEND == "F")
toku_t <- ts(toku_f$NUM,start = 1958, end = 2017, frequency = 1)

plot(toku_t)

toku_W <- HoltWinters(toku_t, beta = FALSE, gamma = FALSE)

plot(toku_W)

toku_c <- ts.union(y = toku_W$x, Levle = toku_W$fitted[, "level"],
                   Residuals = residuals(toku_W))

plot(toku_c)
```



