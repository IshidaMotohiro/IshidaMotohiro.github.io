---
title: EBPM報告
author: "石田基広"
date: "2019年03月27日"
output:
  revealjs::revealjs_presentation:
    theme: blood
    highlight: pygments
    center: true
    increment: true
    reveal_options:
      slideNumber: true
      previewLinks: true
    css: ../style.css
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,eval = FALSE, warning = FALSE, message = FALSE, cache = FALSE)
library(vars)
# library(httr)
library(Nippon)#estat APIでデータの時間を探すべき
library(tidyverse)
library(scales)
library(lubridate)
## 自身のAPPIDを指定
estat <- "http://api.e-stat.go.jp/rest/2.1/app/json/getStatsData?appId=956188d1fe50f81a3f8363310d14ea853eb5827e&lang=J&statsDataId="
ids <- "956188d1fe50f81a3f8363310d14ea853eb5827e"
statID = ""
setwd("~/Dropbox/R/Lectures/2019")
#load("ddf.Rdata")
#load("all_values2.Rdata")
# save.image("20190321.Rdata")
load("20190321.Rdata")
```


## 徳島からの転出超過{#out1}


![](images/year1958-2017-2.png)

```{r}
## tokushima20190316.R
## 長期人口移動 第4表 第5表
## https://www.e-stat.go.jp/stat-search/files?page=1&layout=datalist&toukei=00200523&tstat=000000070001&cycle=0&tclass1=000001051218&survey=%E4%BD%8F%E6%B0%91%E5%9F%BA%E6%9C%AC%E5%8F%B0%E5%B8%B3&result_page=1&second2=1
# 
tokuA <- read_excel(path = "~/Dropbox/R/API/eStat/population/第5表.xls", sheet = 1,
                    range = "H45:BO45",col_names = paste0("Y",1:60),
                    col_types = "numeric") %>% gather

tokuA <- tokuA %>% mutate(YEAR = ymd(paste0(1958:2017, "-01-01")))

tokuM <- read_excel(path = "~/Dropbox/R/API/eStat/population/第5表.xls", sheet = 2,
                   range = "H45:BO45",col_names = paste0("Y",1:60),
                   col_types = "numeric") %>% gather

tokuF <- read_excel(path = "~/Dropbox/R/API/eStat/population/第5表.xls", sheet = 3,
                    range = "H45:BO45",col_names = paste0("Y",1:60),
                    col_types = "numeric") %>% gather

toku <- tibble(NUM = c(tokuM$value, FEMALE = tokuF$value),
               GEND = rep(c("M","F"),each =NROW(tokuF)),
               YEAR = rep(ymd(paste0(1958:2017, "-01-01")),2))


library(ggplot2)
library(scales)

toku %>% mutate(超過 = NUM, 性別 = fct_recode(GEND, 女= "F", 男 = "M"))  %>%
                      ggplot(aes(x = YEAR, y = 超過, col = 性別)) + geom_line() +
                      scale_x_date(labels = date_format("%Y"),date_breaks = "5 year") + 
  theme(axis.text.x = element_text(angle = 30)) +
  ggtitle("1958年から2017年までの転出超過（全年齢）")
```




## 徳島からの転出者数{#out2}

```{r eval=TRUE}
##![](images/kengai.png)
## tokushima_pref.R
# load("~/Dropbox/R/Lectures/2019/all_values2.Rdata")#tokushima_pref.Rを参照
all_values2 %>% filter( tab == "C")  %>% 
  mutate(year = ymd(year),  性別 = fct_recode(cat01, 総数="0", 男 ="1", 女 = "2"),
         転出 = SUM) %>%  
  ggplot(aes(year, 転出,col = 性別)) + geom_line() + # facet_grid(性別 ~ . ) +
  scale_x_date(labels = date_format("%Y"),date_breaks = "1 year") + 
  theme(axis.text.x = element_text(angle = 30)) + 
  ggtitle("徳島からの転出者実数")# + theme_gray(base_family = "HiraKakuPro-W3") 

```




## 転出者数と世代人口{#years10}

```{r eval=TRUE}
## 人口総計データ eStat_how_to.Rmd
tokushima <- all_data %>% filter(`@cat01` == "000", `@area` == "36000") %>% mutate(人数 = as.numeric(`$`) * 1000, 内訳  =  `@cat02`,  年 = year) %>%  mutate(`@cat03`= coalesce(`@cat03`, "002"))  %>% dplyr::select(人数, 内訳  , 年, `@cat03`) %>% filter(`@cat03` == "002")

all_values %>% dplyr::select(-`@unit`) %>% filter(`@tab` %in% c("02","002","03","003")) %>%  
  mutate(
    種類  = fct_collapse(
      `@tab`,      #内移動  = c("01", "001"),
      転入  = c("02", "002"),
      転出  = c("03", "003")),
    #超過  = c("04", "004")
    内訳 = fct_collapse(
      `@cat01`,
      総   = c("0", "001"),
      男  = c("1", "002"),
      女  = c("003", "2"),
      比  = c("004")
    ),
    人数  = as.numeric(`$`),
    年 = ymd(str_replace(`@time`, "000000$", "01-01"))
  ) %>% filter(種類 == "転出", 内訳 == "総") %>% mutate(内訳= fct_recode(内訳, 転出 = "総") ) %>% 
  dplyr::select(人数,内訳,年) %>% 
  bind_rows(tokushima %>% filter (内訳 %in% c("01005", "01006", "01007", "01008", "01009", "01010")) %>% 
              mutate(内訳 = fct_recode(内訳, 転出 = "総", ２０= "01005", ２５= "01006", ３０= "01007", ３５= "01008", ４０= "01009", ４５= "01010"))) %>% 
  ggplot(aes(x = 年, y =  人数, col = 内訳)) + geom_line() + xlab("") +ylab("") +
  scale_y_continuous(limits = c(10000, 55000),
                     breaks = seq(10000, 55000, 2000)) +
  scale_x_date(labels = date_format("%Y"),date_breaks = "1 year") + 
    theme(axis.text.x = element_text(angle = 80))  +  ggtitle("転出数と、主な年齢層の人口概数") 

```


## 年齢階層別転出割合{#out_Age1}

```{r eval=TRUE}
## ![](images/tokushima_out_age_ratio.png)平成21年以前は年齢別データのAPIがない

#https://www.e-stat.go.jp/stat-search/database?page=1&toukei=00200523&tstat=000000070001&result_page=1
# キーワード検索
if(!exists("h24_29")) {
  library(httr)
  url <-
  paste0(
  "http://api.e-stat.go.jp/rest/2.1/app/json/getStatsList?appId=",
  ids,
  "&searchWord=",
  URLencode(
  "年齢（５歳階級），男女別他都道府県からの転入者数，他都道府県への転出者数，転入超過数－全国，都道府県，３大都市圏（東京圏，名古屋圏，大阪圏）"
  )
  
  )
  xx <- GET(url)
  
  content(xx)$GET_STATS_LIST$DATALIST_INF$TABLE_INF[[1]] %>% names
  d_lists  <-
  map_df(content(xx)$GET_STATS_LIST$DATALIST_INF$TABLE_INF,
  ~ .[c("@id", "STATISTICS_NAME")])
  d_lists
  
  h24_29 <- d_lists %>% split(.$`@id`) %>% map_df( ~ {
  # print(paste(.$`@id`, .$STATISTICS_NAME))
  url <- paste0(estat, .$`@id`)
  xx <- GET(url)
  Sys.sleep(2)
  coln <-
  content(xx)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE[[1]] %>% names
  df <-
  map_df(content(xx)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE,
  ~ .[coln])
  df$year <- str_extract(.$STATISTICS_NAME, "平成\\d{2}年")
  df %>% mutate(
  gend = fct_recode(
  `@cat01`,
  総  = "0",
  男  = "1",
  女  = "2"
  ),
  ages = `@cat02`,
  move = fct_recode(
  `@cat03`,
  転入  = "001",
  転出 = "002",
  超過  = "003"
  ),
  area = `@area`,
  num = as.numeric(`$`)
  ) %>%
   dplyr::select(year, move, gend, ages, area, num)
  })
}
h24_29 %>% filter(move == "転出", gend == "総",  area == "36000") %>% group_by(year) %>% mutate(割合 = num / sum(num) * 2) %>% filter(ages %in% c("204","205","206","207") )  %>%
  mutate(年齢 = fct_recode(ages,  １５_１９ =  "204", ２０_２５= "205", ２６_３０ =  "206", ３０_３５= "207")) %>%
  ggplot(aes(x = year, y = 割合, fill = 年齢)) + geom_bar(stat = "identity")+ ggtitle("転出にしめる割合（15歳以上35歳以下に限定）") 

h24_29_total <-  h24_29 %>% filter(move == "転出", gend == "総", ages == "000", area == "36000") 

```



## 年齢階層別転入者割合{#in_Age1}


```{r eval=TRUE}
h24_29 %>% filter(move == "転入", gend == "総",  area == "36000") %>% group_by(year) %>% mutate(割合 = num / sum(num) * 2) %>% filter(ages %in% c("204","205","206","207") )  %>%
  mutate(年齢 = fct_recode(ages,  １５_１９ =  "204", ２０_２５= "205", ２６_３０ =  "206", ３０_３５= "207")) %>%
  ggplot(aes(x = year, y = 割合, fill = 年齢)) + geom_bar(stat = "identity")+ ggtitle("転入にしめる割合（15歳以上35歳以下に限定）") 

```

## 主な転出先{#main_move1}

平成29年

```{r eval=TRUE}
## # https://www.e-stat.go.jp/stat-search/database?page=1&toukei=00200523&tstat=000000070001&result_page=1

if(!exists("ddf")) {
  search <-
    paste0(
    "http://api.e-stat.go.jp/rest/2.1/app/json/getStatsList?appId=",
    ids,
    "&searchWord=",
    URLencode("男女，移動前の住所地別転入者数及び男女，移動後の住所地別転出者数－都道府県）")# 各年の 007
    )##URLencode(""),"&searchKind=2",
    
  xx <- GET(search)
  str(xx)
  length(xx)
  d_lists  <-
  map_dfr(content(xx)$GET_STATS_LIST$DATALIST_INF$TABLE_INF,
  ~ .[c("@id", "STATISTICS_NAME")])
  d_lists
  
  d_ <- d_lists %>% split(.$`@id`) %>% map_dfr(., ~ {
  url_ <- paste0(estat, .["@id"])
  year_ <- str_extract(.$STATISTICS_NAME, "平成\\d{2}年")
  # Sys.sleep(2)
  print(year_)
  H_ <- GET(url_)
  
  Sys.sleep(2)
  
  coln <-
  content(H_)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE[[1]] %>% names()
  df_ <-
  map_df(content(H_)$GET_STATS_DATA$STATISTICAL_DATA$DATA_INF$VALUE,
  ~ .[coln])
  df_ %>% add_column(Year = year_)
  })
  ddf  <-
  d_ %>% mutate(
  from = `@cat01`,
  gend = `@cat02`,
  in_out = `@cat03`,
  japanese61 = `@cat04`,
  area  = `@area`,
  人数  = as.numeric(`$`)
  )  %>% select(Year, from, gend, in_out, japanese61, area,  人数)
  ddf <- ddf %>% left_join(area, by = c("area" = "@code")) %>% mutate(地域 = `@name`) %>% dplyr::select(-`@level`)
}

# ddf %>% filter(Year == "平成24年", from == "36000", area == "27000") 

## 転出数 のチェック
remove_area <- ddf %>% tail(22) %>% dplyr::select(area) %>% pull
## ddf %>% filter(Year == "平成29年", gend == "0", from  == "36000", in_out == "002", !area %in% c("00999", remove_area))  %>%  summarise(SUM = sum(人数, na.rm = TRUE))
cities <- ddf %>% filter(Year == "平成29年", gend == "0", from == "36000", in_out == "001") %>% tail(22)
ddf %>% filter(Year == "平成29年", gend == "0", from == "36000", in_out == "002", !area %in% cities$area) %>% 
  dplyr::select(地域,人数) %>% arrange(desc(人数))%>% head(10) %>% knitr::kable()
```


## 主な転入元{#main_in1}

平成29年

```{r eval=TRUE}
ddf %>% filter(Year == "平成29年", gend == "0", from == "36000", in_out == "001", !area %in% cities$area) %>% 
  dplyr::select(地域,人数) %>% arrange(desc(人数)) %>% head(10) %>% knitr::kable()
```

## 転出先上位{#out_top3}


```{r eval=TRUE}
# "13000"  "27000"
ddf %>% filter(gend == "0", from == "36000", area %in%  c("13000" ,"27000","37000"), in_out == "002") %>% dplyr::select(Year, area, 人数) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 地域 = fct_recode(area, 東京="13000" ,大阪="27000",香川県="37000"))  %>% ggplot(aes(x = Year, y = 人数, col = 地域)) + geom_line()+  ggtitle("転出先上位") 
```



```{r}
# "13000"  "27000"
ddf %>% filter(gend == "0", from == "36000", area %in%  c("13000" ,"27000","37000"), in_out == "002") %>% dplyr::select(Year, area, 人数) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 地域 = fct_recode(area, 東京="13000" ,大阪="27000",香川県="37000"))  %>% ggplot(aes(x = Year, y = 人数, col = 地域)) + geom_line()+  ggtitle("転入元上位") 
```


## 転入元上位{#in_top3}


```{r eval=TRUE}
# "13000"  "27000"
ddf %>% filter(gend == "1", from == "36000", area %in%  c("13000" ,"27000","37000"), in_out == "001") %>% dplyr::select(Year, area, 人数) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 地域 = fct_recode(area, 東京="13000" ,大阪="27000",香川県="37000"))  %>% ggplot(aes(x = Year, y = 人数, col = 地域)) + geom_line()
```

## 香川との転出入数{#kagawa}

```{r eval=TRUE}
ddf %>% filter(gend == "1", from == "36000", area %in%  c("37000"), in_out %in% c("001", "002")) %>% dplyr::select(Year, 地域, 人数, in_out) %>% mutate(Year =ymd(paste0(wareki2AD(str_extract(Year, "平成\\d{2}年")), "-01-01")), 転出入 = fct_recode(in_out, 転入 = "001", 転出= "002"))  %>% ggplot(aes(x = Year, y = 人数, col = 転出入 )) + geom_line()
```




## 転出超過数(再掲){#tensyutsu}

```{r eval=TRUE}
tokuA  %>% filter(YEAR %within% interval(ymd("1975-01-01"), ymd ("2018-01-01")) )  %>% 
  dplyr::select(転出超過 =value, YEAR) %>% 
                      ggplot(aes(x = YEAR, y = 転出超過)) + geom_line() +
                      scale_x_date(labels = date_format("%Y"),date_breaks = "5 year") + 
  theme(axis.text.x = element_text(angle = 80)) +
  ggtitle("1975年から2017年までの転出超過（全年齢）")
```


## 転出超過を説明{#covariance}

1. 実質GDP成長率
2. 地域間所得格差
3. 新規有効求人倍率


## 実質GDP{#gdp}

```{r eval=TRUE}
library(readxl)
dgp <- read_excel("~/Dropbox/R/API/eStat/population/gdp.xls", sheet = 1)
d_d2 <- tokuA %>% dplyr::select(年 = YEAR, 超過 = value)  %>% left_join(dgp %>% dplyr::mutate(年 = ymd(paste0(year, "-01-01"))) %>% dplyr::select(年,GDP))   %>% 
  filter(年 %within% interval(ymd ("1999-01-01"), ymd("2017-01-01"))) %>% arrange(年) %>% dplyr::select(超過,GDP)


all_values2 %>% filter(tab == "D", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(dgp) %>% 
  mutate(転出超過 = SUM, year = ymd(paste0(year,"-01-01"))) %>%
  ggplot() + geom_line(aes(x = year, y = 転出超過 ))  + 
  scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
  geom_line(aes(x = year, y = rescale(GDP, to = range(転出超過)) , col = "red"))  + 
  scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(dgp$GDP)), name = "GDP")) +
   theme(axis.text = element_text(angle = 80))# + theme_gray(base_family = "HiraKakuPro-W3") 
```


## 徳島の求人倍率{#tokushima_shinki}



```{r eval=TRUE}
## R/API/eStat/population/tokushima20190316.R
## load("~/Dropbox/R/Lectures/2019/shinki_.Rdata")%>% mutate(year = year(year)) 
shinki_mean1 <- shinki_ %>% mutate(year = ymd(X__1), year =year(year)) %>% group_by(year) %>% summarise(徳島 = mean(`36徳島`), 香川 = mean(`37香川`)) %>% mutate(year = ymd(paste0(year, "-01-01")))
library(scales)

tokushima_q <- tokuA %>% dplyr::select(year = YEAR, 転出超過 = value) %>% left_join(shinki_mean1) %>% 
  filter(year %within% c(interval(ymd("1975-01-01"), ymd("2017-01-01"))))

tokushima_q %>%
  ggplot() + geom_line(aes(x = year, y = 転出超過  ))  + 
  scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
  geom_line(aes(x = year, y = rescale(徳島, to = range(転出超過) ) ), col = "red") + 
  scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(shinki_mean1$徳島)), name = "徳島新規有効求人倍率"))+
   theme(axis.text = element_text(angle = 80))# + theme_gray(base_family = "HiraKakuPro-W3") 
# file
# 
# shinki_mean1 <- shinki_ %>% mutate(year = ymd(X__1), year =year(year)) %>% group_by(year) %>% summarise(徳島 = mean(`36徳島`), 香川 = mean(`37香川`)) 
# all_values2 %>% filter(tab == "D", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean1) %>% 
#   mutate(転出超過 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>%
#   ggplot() + geom_line(aes(x = year, y = 転出超過  ))  + 
#   scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
#   geom_line(aes(x = year, y = rescale(徳島, to = range(転出超過) ) ), col = "red") + 
#   scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(shinki_mean1$徳島)), name = "徳島新規有効求人倍率"))+
#    theme(axis.text = element_text(angle = 30))# + theme_gray(base_family = "HiraKakuPro-W3") 
# # file
```


## 大阪の求人倍率{#osaka_shinki}

```{r eval=TRUE}
## 
if(! exists("all_values2")) {
  load("~/Dropbox/R/Lectures/2019/all_values2.Rdata")
}
shinki_osaka <- shinki_ %>% mutate(year = ymd(X__1), year = year(year)) %>% group_by(year) %>% summarise(大阪 = mean(`27大阪`), 近畿 = mean(`G 近畿`))%>% mutate(year = ymd(paste0(year, "-01-01")))
#scale_to_value1 <- function(values) rescale(values, to = range(x$転出数))
# scale_to_value2 <- function(values) rescale(values, to = range(x$大阪))

osaka_q <- tokuA %>% dplyr::select(year = YEAR, 転出超過 = value) %>% left_join(shinki_osaka) %>% 
  filter(year %within% c(interval(ymd("1975-01-01"), ymd("2017-01-01"))))

osaka_q  %>%
  ggplot() + geom_line(aes(x = year, y = 転出超過  ))  + 
  scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
  geom_line(aes(x = year, y = rescale(大阪, to = range(転出超過) ) ), col = "red") + 
  scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(shinki_osaka$大阪)), name = "徳島新規有効求人倍率"))+
   theme(axis.text = element_text(angle = 80))# + theme_gray(base_family = "HiraKakuPro-W3") 
# # file
# all_values2 %>% filter(tab == "D", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_mean) %>% 
#   mutate(転出超過 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>%
#   ggplot() + geom_line(aes(x = year, y = 転出超過 ))  + 
#   scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
#   geom_line(aes(x = year, y = rescale(大阪, to = range(転出超過)) , col = "red"))  + 
#   scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(shinki_mean$ 大阪)), name = "大阪有効求人倍率")) +
#    theme(axis.text = element_text(angle = 30))# + theme_gray(base_family = "HiraKakuPro-W3") 
```

## 徳島と大阪の求人倍率差{#tokushima_osaka}

```{r eval=TRUE}
shinki_sa <- shinki_all %>% dplyr::select(X__1, 大阪=`27大阪`,徳島=`36徳島`) %>% mutate(year = year(X__1), 差 = 徳島 - 大阪) %>% dplyr::select(year, 差)%>% group_by(year) %>%　summarise(差 = mean(差)) %>% 
  mutate(year = ymd(paste0(year, "-01-01")))

sa <- tokuA %>% dplyr::select(year = YEAR, 転出超過 = value) %>% left_join(shinki_sa) %>% 
  filter(year %within% c(interval(ymd("1975-01-01"), ymd("2017-01-01"))))

sa %>%
  ggplot() + geom_line(aes(x = year, y = 転出超過  ))  + 
  scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
  geom_line(aes(x = year, y = rescale(差, to = range(転出超過) ) ), col = "red")+
  geom_line(aes(x = year, y = rescale(差, to = range(転出超過) ) ), col = "red") + 
  scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(shinki_sa$差)), name = "徳島・大阪の間の新規有効求人倍率の差"))+
   theme(axis.text = element_text(angle = 80))# 
# 
# all_values2 %>% filter(tab == "D", cat01 == "総") %>% mutate(year = year(year)) %>% left_join(shinki_sa) %>% 
#   mutate(転出超過 = SUM, 内訳 = cat01, year = ymd(paste0(year,"-01-01"))) %>%
#   ggplot() + geom_line(aes(x = year, y = 転出超過  ))  + 
#   scale_x_date(labels = date_format("%Y"), date_breaks = "1 year") +
#   geom_line(aes(x = year, y = rescale(差, to = range(転出超過) ) ), col = "red") + 
#   scale_y_continuous(name = "転出超過", sec.axis =  sec_axis(~ rescale(., to = range(shinki_mean1$徳島)), name = "徳島新規有効求人倍率"))+
#    theme(axis.text = element_text(angle = 30))# + theme_gray(base_family = "HiraKakuPro-W3") 
# # file

```


## 統計モデル{#modeling}

転出超過を新規有効求人倍率の差で説明

1. 原系列は定常(KPSS検定)
2. 二変量時系列解析（VARモデル）
3. VARモデルによる予測

```{r}
# 2. 共和分はない(Phillips-Ouliaris検定)
library(urca)# 帰無仮説単位根なし
# 
# summary(ur.kpss(sa$転出超過)) 
# summary(ur.kpss(sa$差))
## summary(ur.df(sa$転出超過, type = "none")) 
## summary(ur.df(sa$差))
data_mat <- matrix(nrow = NROW(sa), ncol = 2)
data_mat [,1] <- sa$転出超過
data_mat [,2] <- sa$差
# summary(ca.po(data_mat, demean = "none"))
```

```{r eval=TRUE}
library(vars)
sa_t <- sa %>% dplyr::select(-year)
sa_t <- ts(sa_t, start = 1975, end = 2017, frequency = 1)
jigen_sa <- VARselect(sa_t)
model_vars_sa <- VAR(y = sa_t, type = "const", p = jigen_sa$selection[1])
## summary(model_vars)
# plot(model_vars_sa, name = "転出超過")
#causality(model_vars, cause = "大阪") 
# causality(model_vars_sa, cause = "転出超過")


```

## 当てはめ結果{#fitting}

![](images/vars_sa.png)

## 転出超過数の予測{#predict}

2018年を取り除いての分析

2018年以降を予測

```{r eval=TRUE}
predict(model_vars_sa, n.ahead = 5)[[1]]$転出超過 %>% broom::tidy() %>% 
  add_column(年 = c("2018","2019","2020","2021","2022"), .before = "fcst") %>% 
  knitr::kable()
```

ちなみに2018年の転出超過は-2531

## 転出数の予測範囲{#predict_range}

![](images/local_auto_sa_tr.png)

```{r}
library(ggfortify)
autoplot(predict(model_vars_sa, n.ahead = 5), ts.colour = 1, predict.color = 1,predict.linetype = "dashed")
```

```{r}
# ![](images/vars_tr)
# トレンド付きモデル
jigen_sa_tr <- VARselect(sa_t, type = "both")
model_vars_tr <- VAR(y = sa_t, type = "both", p = jigen_sa_tr$selection[1])
summary(model_vars_tr)
plot(model_vars_tr, names = "転出超過")
#causality(model_vars, cause = "大阪") 
causality(model_vars_tr, cause = "転出超過")
predict(model_vars_tr, n.ahead = 5)[[1]]$転出 %>% broom::tidy() %>% 
  add_column(年 = c("2018","2019","2020","2021","2022"), .before = "fcst") %>% 
  knitr::kable()
```



## 課題

10月に消費税増税


1. 増税などのイベントの取り込み
2. 共変量の追加
3. 状態空間モデルでの推定



## ローカルトレンドモデル{#localtrend1}

![](images/localtrend.png)

```{r}

flag <- sa$year %in% c(ymd("1975-01-01"), ymd("1985-01-01"), ymd("1990-01-01"),ymd("1995-01-01"),ymd("2008-01-01"),ymd("2014-01-01"))

build_trend_reg <- SSModel(
  H = NA,
  sa$転出超過 ~ SSMtrend(degree = 2, Q = c(list(NA), list(NA))) + 
  SSMregression(~ sa$差, Q = NA) +flag
    
)

fit_trend_reg <- fitSSM(build_trend_reg, inits = c(1,1,1,1))

result_trend_reg <- KFS(
  fit_trend_reg$model,
  filtering = c("state","mean"),
  smoothing = c("state", "mean")
)

interval_coef <- predict(fit_trend_reg$model, states = "regression",
                         interval = "confidence", level = 0.95)

coef_data <- cbind(data.frame(year = 1975:2017),
                   as.data.frame(interval_coef))


forecast_trend_reg <- predict(fit_trend_reg$model, interval = "confidence", level = 0.95)

estimate <- cbind(data.frame(year = 1975:2017),
                   as.data.frame(forecast_trend_reg))

estimate %>% ggplot(aes(x = year, y = sa$転出超過)) + geom_point() + geom_line(aes(y = fit),alpha = .3) +
  geom_ribbon(aes(ymin= lwr, ymax = upr), alpha = .3)

p_data <- autoplot(result_trend_reg$model$y, main ="転出数")
p_trend <- autoplot(result_trend_reg$alphahat[, "level"], main = "トレンド" )

gridExtra::grid.arrange(p_data, p_trend)
# 
# p_shinki <- autoplot(result_trend_reg$alphahat[, "sa"], main = "求人倍率")
# p_slope <- autoplot(result_trend_reg$alphahat[, "slope"], main = "係数")
# 
# gridExtra::grid.arrange(p_data, p_trend, p_shinki, p_slope )
```



## ローカルトレンドモデル{#localtrend2}

![](images/localtrend2.png)